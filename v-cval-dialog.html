<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="v-cval-dialog">
    <style>
        :host {
            position: absolute;
            width: 20%;
            left: 0;
            right: 0;
            margin: 0 auto;
            background-color: gray;
        }

        #v-cval-dialog-header {
            color: white;
            background-color: black;
        }
    </style>
    <template>
        <div id="v-cval-dialog">
            <div id="v-cval-dialog-header">{{header}}</div>
            <div id="v-cval-dialog-explanation">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation
                ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in
                voluptate
                velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt
                in
                culpa qui officia deserunt mollit anim id est laborum.
            </div>
            <div id="v-cval-dialog-input"><input id="v-cval-dialog-input-field" type="text"/>
                <button on-click="onClick">Submit</button>
            </div>
            <div id="v-cval-dialog-license-link"><a href="https://vaadin.com/pro-tools">Lorem ipsum dolor sit amet</a>
            </div>
        </div>
    </template>
</dom-module>

<script>
    // element registration
    CvalDialog = Polymer({
        is: "v-cval-dialog",

        properties: {
            header: String
        },

        constructor: function (header) {
            this.header = header;
        },

        onClick: function () {
            //ugly copying
            var licenseKey = this.$['v-cval-dialog-input-field'].value;

            var licenseUrl = this.computeUrl(licenseKey);

            var client = new XMLHttpRequest();

            client.open("GET", licenseUrl, true);

            client.setRequestHeader("Content-Type", "application/json;charset=utf-8");

            client.onerror = this.handleErrorFromServer.bind(this);

            client.onload = this.handleResultFromServer.bind(this);

            client.send("");

        },

        computeUrl: function (licenseKey) {
            //return "https://tools.vaadin.com/vaadin-license-server/licenses/" + licenseKey;
            return "http://localhost:8080/mockserver/" + licenseKey;
        },

        handleErrorFromServer: function (event) {
            console.log("License request failed, status: " + this.status + " failure text: " + this.responseText);
        },

        handleResultFromServer: function (event) {
            //ugly copying
            function isValidChartsLicense(resultJson) {
                return resultJson.product.name === "vaadin-charts" &&
                        resultJson.product.version === 3 && !resultJson.expired;

            };

            var response = event.target;

            console.log("Result status: " + response.status + " result text: " + response.responseText);

            if (response.status != 200) {
                console.log("Show invalid license dialog");
            } else {
                var result = JSON.parse(response.responseText);

                if ("evaluation" === result.type) {
                    //show evaluation box
                    console.log("Show evaluation box");

                } else if (!isValidChartsLicense(result)) {
                    //show unlicensed / expired dialog
                    console.log("Show expired dialog")
                }else {
                    window.localStorage.setItem("vaadin.charts.developer.license.key", result.licenseKey);
                    this.remove();
                }
            }
        }

    });
</script>
