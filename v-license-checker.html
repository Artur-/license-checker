<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="v-license-box.html">

<script>
    LicenseCheck = Polymer({
        is: "v-license-check",

        // simple global state to detect multiple instances
        instances: {},

        properties: {
            licenseKey: String,
            licenseUrlBase: {
                type: String,
                value: "https://tools.vaadin.com/vaadin-license-server/licenses/"
            },
            licenseUrl: {
                type: String,
                computed: '_computeUrl(licenseUrlBase, licenseKey)'
            },
            productName: String,
            productVersion: Number,
            storageKey: {
                type: String,
                computed: '_computeStorageKey(productName)'
            }
        },

        attached: function () {
            if (!this._exists(this.instances[this.storageKey])) {
                this.instances[this.storageKey] = this;

                if (this._isLocalhost()) {
                    if (this._exists(this.licenseKey)) {
                        this._checkLicenseKey();

                    } else if (this._exists(window.localStorage.getItem(this.storageKey))) {
                        this.licenseKey = window.localStorage.getItem(this.storageKey);
                        this._checkLicenseKey();

                    } else {
                        var newElem = new LicenseBox("Unlicensed copy", "error");
                        Polymer.dom(this).appendChild(newElem);
                    }
                }
            }
        },

        _checkLicenseKey: function () {
            var licenseUrl = this._computeUrl(this.licenseUrlBase, this.licenseKey);
            console.log("checking with license url " + licenseUrl);

            var client = new XMLHttpRequest();

            client.open("GET", licenseUrl, true);

            client.setRequestHeader("Content-Type", "application/json;charset=utf-8");

            client.onerror = this._handleErrorFromServer.bind(this);

            client.onload = this._handleResultFromServer.bind(this);

            client.send("");
        },

        _computeUrl: function (licenseUrlBase, licenseKey) {
            return licenseUrlBase + licenseKey;
        },

        _handleErrorFromServer: function (event) {
            var response = event.target;
            console.log("License request failed, status: " + response.status + " failure text: " + this.responseText);
            var newElem = new LicenseBox("Unlicensed copy", "error");
            Polymer.dom(this).appendChild(newElem);

            this._fireLoadReadyEvent()
        },

        _handleResultFromServer: function (event) {
            var response = event.target;

            console.log("Result status: " + response.status + " result text: " + response.responseText);

            if (response.status != 200) {
                console.log("Show invalid license dialog");

                var newElem = new LicenseBox("Unlicensed copy", "error");
                Polymer.dom(this).appendChild(newElem);

            } else {
                var result = JSON.parse(response.responseText);

                if ("evaluation" === result.type) {
                    //show evaluation box
                    console.log("Show evaluation box");
                    var newElem = new LicenseBox("Evaluation copy", "evaluation");
                    Polymer.dom(this).appendChild(newElem);

                } else if (!isValidLicense(result.product.name, result.product.version)) {
                    //show unlicensed / expired dialog
                    console.log("Show expired dialog")

                    var newElem = new LicenseBox("Unlicensed copy", "error");
                    Polymer.dom(this).appendChild(newElem);
                }
            }

            this._fireLoadReadyEvent()
        },

        _isLocalhost: function () {
            var hostname = window.location.hostname;
            return (hostname === "localhost" || hostname === "127.0.0.1");
        },

        _isValidLicense: function (productName, productVersion) {
            return productName === this.productName &&
                    productVersion === this.productVersion && !resultJson.expired;

        },

        _fireLoadReadyEvent: function () {
            this.fire("license-check-done");
        },

        _exists: function (value) {
            return value !== null && value !== undefined
        },

        _computeStorageKey: function (productName) {
            return "vaadin." + productName + ".developer.license.key";
        }
    });
</script>
