<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="v-license-box.html">
<link rel="import" href="v-license-dialog.html">

<script>
    LicenseCheck = Polymer({
        is: "v-license-check",

        // simple global state to detect multiple instances
        instances: {},

        licenseDialog: undefined,

        licenseBox: undefined,

        licenseTypes: {
            VALID: "valid",
            UNLICENSED: "unlicensed",
            TRIAL: "trial",
            EXPIRED: "expired"
        },

        properties: {
            licenseKey: String,
            licenseUrlBase: {
                type: String,
                value: "https://tools.vaadin.com/vaadin-license-server/licenses/"
            },
            licenseUrl: {
                type: String,
                computed: '_computeUrl(licenseUrlBase, licenseKey)'
            },
            productName: String,
            productVersion: Number,
            storageKey: {
                type: String,
                computed: '_computeStorageKey(productName)'
            }
        },

        attached: function () {
            if (!this._exists(this.instances[this.storageKey])) {
                this.instances[this.storageKey] = this;

                if (this._isLocalhost()) {
                    if (this._exists(this.licenseKey)) {
                        this._checkLicenseKey();

                    } else if (this._exists(window.localStorage.getItem(this.storageKey))) {
                        this.licenseKey = window.localStorage.getItem(this.storageKey);
                        this._checkLicenseKey();

                    } else {
                        this._showLicenseDialog(this.licenseTypes.UNLICENSED);
                    }
                }
            }
        },

        detached: function () {
            if (this.licenseBox) {
                this.licenseBox.remove();
                this.licenseBox = undefined;
            }
            if (this.licenseDialog) {
                this.licenseDialog.remove();
                this.licenseDialog = undefined;
            }

            if(this.instances[this.storageKey] === this) {
                this.instances[this.storageKey] = undefined;
            }
        },

        _checkLicenseKey: function () {
            var licenseUrl = this._computeUrl(this.licenseUrlBase, this.licenseKey);
            console.log("checking with license url " + licenseUrl);

            var client = new XMLHttpRequest();

            client.open("GET", licenseUrl, true);

            client.setRequestHeader("Content-Type", "application/json;charset=utf-8");

            client.onerror = this._handleErrorFromServer.bind(this);

            client.onload = this._handleResultFromServer.bind(this);

            client.send("");
        },

        _computeUrl: function (licenseUrlBase, licenseKey) {
            return licenseUrlBase + licenseKey;
        },

        _handleErrorFromServer: function (event) {
            var response = event.target;
            console.log("License request failed, status: " + response.status + " failure text: " + this.responseText);
            var newElem = new LicenseBox("Unlicensed copy", "error");
            Polymer.dom(this).appendChild(newElem);

            this._fireLoadReadyEvent()
        },

        _handleResultFromServer: function (event) {
            var response = event.target;

            console.log("Result status: " + response.status + " result text: " + response.responseText);

            if (response.status != 200) {
                console.log("Show unlicensed  dialog");

                var newElem = new LicenseDialog("Unlicensed copy", "error");
                Polymer.dom(this).appendChild(newElem);

            } else {
                var result = JSON.parse(response.responseText);

                if ("evaluation" === result.type) {
                    //show evaluation box
                    console.log("Show evaluation box");
                    var newElem = new LicenseBox("Evaluation copy", "evaluation");
                    Polymer.dom(this).appendChild(newElem);

                } else if (!_isValidLicense(result.product.name, result.product.version)) {
                    //show unlicensed / expired dialog
                    console.log("Show expired dialog")

                    var newElem = new LicenseBox("Unlicensed copy", "error");
                    Polymer.dom(this).appendChild(newElem);
                }
            }

            this._fireLoadReadyEvent()
        },

        _isLocalhost: function () {
            var hostname = window.location.hostname;
            return (hostname === "localhost" || hostname === "127.0.0.1");
        },

        _isValidLicense: function (productName, productVersion) {
            return productName === this.productName &&
                    productVersion === this.productVersion && !resultJson.expired;

        },

        _fireLoadReadyEvent: function () {
            this.fire("license-check-done");
        },

        _exists: function (value) {
            return value !== null && value !== undefined && value !== "";
        },

        _computeStorageKey: function (productName) {
            return "vaadin." + productName + ".developer.license.key";
        },


        _licenseDialogClosed: function (event) {
            this._showLicenseBox(event.detail.type);
        },

        _licenseBoxClosed: function (event) {
            this._showLicenseDialog(event.detail.type);
        },

        _showLicenseDialog: function (type) {
            if (this.licenseDialog) {
                this.licenseDialog.remove();
                this.licenseDialog = {};
            }
            this.licenseDialog = new LicenseDialog(type, this.productName);
            this.licenseDialog.addEventListener('v-license-dialog-close', this._licenseDialogClosed.bind(this));
            Polymer.dom(document.body).appendChild(this.licenseDialog);
        },

        _showLicenseBox: function (type) {
            if (this.licenseBox) {
                this.licenseBox.remove();
                this.licenseDialog = {};
            }
            this.licenseBox = new LicenseBox(type, this.productName);
            this.licenseBox.addEventListener('v-license-box-close', this._licenseBoxClosed.bind(this));
            Polymer.dom(document.body).appendChild(this.licenseBox);
        }

    });
</script>
