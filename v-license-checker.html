<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="v-license-box.html">
<link rel="import" href="v-license-dialog.html">
<link rel="import" href="v-license-notification.html">

<dom-module id="v-license-check">

    <template>
        <iron-localstorage name="[[storageKey]]"
                           value="{{licenseKey}}"
                           use-raw="true">

        </iron-localstorage>

        <iron-ajax
                id="licenseRequest"
                url="[[licenseUrl]]"
                handle-as="json"
                on-response="_handleResultFromServer"
                on-error="_handleErrorFromServer"
                debounce-duration="300">
        </iron-ajax>
    </template>

    <script>
        LicenseCheck = Polymer({
            is: "v-license-check",

            // simple global state to detect multiple instances
            instances: {},

            licenseDialog: undefined,

            licenseBox: undefined,

            notification: undefined,

            licenseTypes: {
                VALID: "valid",
                UNLICENSED: "unlicensed",
                TRIAL: "trial",
                EXPIRED: "expired"
            },

            properties: {
                licenseKey: String,
                licenseUrlBase: {
                    type: String,
                    value: "https://tools.vaadin.com/vaadin-license-server/licenses/"
                },
                licenseUrl: {
                    type: String,
                    computed: '_computeUrl(licenseUrlBase, licenseKey)'
                },
                productName: String,
                productVersion: Number,
                storageKey: {
                    type: String,
                    computed: '_computeStorageKey(productName)'
                }
            },

            attached: function () {
                if (!this._exists(this.instances[this.storageKey])) {
                    this.instances[this.storageKey] = this;

                    if (this._isLocalhost()) {
                        if (this._exists(this.licenseKey)) {
                            this._checkLicenseKey();

                        } else {
                            this._showLicenseDialog(this.licenseTypes.UNLICENSED);
                        }
                    }
                }
            },

            detached: function () {
                if (this.licenseBox) {
                    this.licenseBox.remove();
                    this.licenseBox = undefined;
                }
                if (this.licenseDialog) {
                    this.licenseDialog.remove();
                    this.licenseDialog = undefined;
                }
                if (this.notification) {
                    this.notification.remove();
                    this.notification = undefined;
                }

                if (this.instances[this.storageKey] === this) {
                    this.instances[this.storageKey] = undefined;
                }
            },

            _checkLicenseKey: function (key) {
                if (arguments.length === 0) {
                    //no-args call
                    key = this.licenseKey;
                }

                var licenseUrl = this._computeUrl(this.licenseUrlBase, key);
                console.log("checking with license URL " + licenseUrl);

                this.$.licenseRequest.url = licenseUrl;

                this.$.licenseRequest.generateRequest();
            },

            _computeUrl: function (licenseUrlBase, licenseKey) {
                return licenseUrlBase + licenseKey;
            },

            _handleErrorFromServer: function (event) {
                var response = event.detail.request;
                console.log("License request failed, status: " + response.status + " failure text: " + this.response);
                this._showLicenseDialog(this.licenseTypes.UNLICENSED)

                this._fireLoadReadyEvent()
            },

            _handleResultFromServer: function (event) {
                var response = event.detail;

                console.log("Result status: " + response.status + " result text: " + JSON.stringify(response.response));

                var result = response.response;

                //result is either invalid somehow, expired, evaluation or successful
                if (response.status != 200 || !this._isValidLicense(result.product.name, result.product.version)) {
                    this._showLicenseDialog(this.licenseTypes.UNLICENSED)

                } else {
                    if (true === result.expired) {
                        this._showLicenseBox(this.licenseTypes.EXPIRED);

                    } else if ("evaluation" === result.type) {
                        this._showLicenseBox(this.licenseTypes.TRIAL);

                    } else {
                        //success
                        if (this.licenseKey !== result.licenseKey) {
                            //user entered key to dialog
                            //show success notification and save value
                            this._showSuccessNotification();
                            this.licenseKey = result.licenseKey;
                        }
                    }
                }

                this._fireLoadReadyEvent()
            },

            _isLocalhost: function () {
                var hostname = window.location.hostname;
                return (hostname === "localhost" || hostname === "127.0.0.1");
            },

            _isValidLicense: function (productName, productVersion) {
                return productName === this.productName &&
                        productVersion === this.productVersion;
            },

            _fireLoadReadyEvent: function () {
                this.fire("license-check-done");
            },

            _exists: function (value) {
                return value !== null && value !== undefined && value !== "";
            },

            _computeStorageKey: function (productName) {
                return "vaadin." + productName + ".developer.license.key";
            },


            _licenseDialogClosed: function (event) {
                this._showLicenseBox(event.detail.type);
            },

            _licenseBoxClosed: function (event) {
                this._showLicenseDialog(event.detail.type);
            },

            _licenseBoxSubmit: function (event) {
                //check the key without saving it first
                this._checkLicenseKey(event.detail.licenseKey);
            },

            _showLicenseDialog: function (type) {
                if (!this.licenseDialog) {
                    this.licenseDialog = new LicenseDialog();
                    Polymer.dom(document.body).appendChild(this.licenseDialog);
                    this.licenseDialog.addEventListener('v-license-dialog-close', this._licenseDialogClosed.bind(this));
                    this.licenseDialog.addEventListener('v-license-dialog-submit', this._licenseBoxSubmit.bind(this));
                }

                this.licenseDialog.type = type;
                this.licenseDialog.productName =  this.productName;

                this.licenseDialog.open();
            },

            _showLicenseBox: function (type) {
                if (!this.licenseBox) {
                    this.licenseBox = new LicenseBox();
                    Polymer.dom(document.body).appendChild(this.licenseBox);
                    this.licenseBox.addEventListener('v-license-box-close', this._licenseBoxClosed.bind(this));
                }

                this.licenseBox.type = type;
                this.licenseBox.productName = this.productName;

                this.licenseBox.open();
            },

            _showSuccessNotification: function () {
                if (!this.notification) {
                    this.notification = new LicenseNotification();
                    Polymer.dom(document.body).appendChild(this.notification);
                }

                this.notification.open();
            }

        });
    </script>
</dom-module>
