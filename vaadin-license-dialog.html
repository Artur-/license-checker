<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">

<dom-module id="vaadin-license-dialog">
    <style>
        :host {
            box-sizing: border-box;
            display: inline-block;
            vertical-align: top;
            text-align: left;
            border-radius: 4px;
            background-color: white;
            color: #474747;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1), 0 16px 80px -6px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.09098);
            padding: 0;
            min-width: 148px !important;
            min-height: 37px !important;
            /*white-space: nowrap;*/
            overflow: hidden !important;
            transition: width 200ms, height 200ms, top 200ms, left 200ms;
            margin-left: 0px;
            margin-top: 0px;
            z-index: 10000;
            visibility: visible;
            position: absolute;
            width: 300px;
        }
    </style>
    <template>
        <div id="licenseDialogHeader">
            <span>[[header]]</span>
            <span id="licenseDialogClose" on-click="_close">X</span>
        </div>
        <div id="licenseDialogExplanation"></div>
        <div id="vaadin-license-dialog-input">
            <input id="licenseDialogInput" type="text">
            <button on-click="_submit">Submit</button>
        </div>
    </template>

    <script>
        LicenseDialog = Polymer({
            is: "vaadin-license-dialog",

            behaviors: [Polymer.IronOverlayBehavior],

            headers: {
                unlicensed: "Unlicensed copy of {0}",
                trial: "{0} trial license",
                expired: "{0} license expired"
            },

            contents: {
                unlicensed: 'To use {0} in development, each developer needs to have a valid license. Please <a href="https://vaadin.com/pro/licenses" target="_blank"> get a license from vaadin.com</a>, then enter your license key here:',
                trial: 'You are currently using {0} with a trial license, which will expire {1}. You can <a href="https://vaadin.com/pro/licenses" target="_blank"> visit vaadin.com to get a paid license</a>, then enter your license key here:',
                expired: 'Your {0} license has expired. Please <a href="https://vaadin.com/pro/licenses" target="_blank">renew your license at vaadin.com</a>, then refresh the page. Alternatively, if you have a new license key, you can enter it here:'
            },

            properties: {
                type: String,
                productCaption: String,
                expiryEpoch: {
                    type: Number,
                    value: 0
                },

                header: {
                    type: String,
                    computed: '_computeHeader(type, productCaption)'
                },
                content: {
                    type: String,
                    observer: '_contentChanged',
                    computed: '_computeContent(type, productCaption, expiryEpoch)'
                },

                //override
                withBackdrop: {
                    type: Boolean,
                    value: true
                },
                noCancelOnEscKey: {
                    type: Boolean,
                    value: true
                },
                noCancelOnOutsideClick: {
                    type: Boolean,
                    value: true
                }
            },

            _contentChanged: function(value) {
                this.$.licenseDialogExplanation.innerHTML = value;
            },

            _submit: function() {
                this.fire('vaadin-license-dialog-submit', {
                    licenseKey: this.$.licenseDialogInput.value
                });
                this.close();
            },

            _close: function() {
                this.fire('vaadin-license-dialog-close', {
                    type: this.type,
                    expiryEpoch: this.expiryEpoch
                });
                this.close();
            },

            _computeHeader: function(type, productCaption) {
                return this.headers[type].replace('{0}',
                    productCaption);
            },

            _computeContent: function(type, productCaption, expiryEpoch) {
                if (type === 'trial') {
                    var timeToExpiry = expiryEpoch - Date.now();
                    var hoursToExpiry = Math.round(timeToExpiry /
                        1000 / 60 / 60);
                    var daysToExpiry = Math.round(timeToExpiry /
                        1000 / 60 / 60 / 24);
                    var expiryDate = new Date(expiryEpoch);
                    var expiryDateISOFormat = expiryDate.getFullYear() +
                        '-' + this._padDate(expiryDate.getMonth()) +
                        '-' + this._padDate(expiryDate.getDate());

                    if (hoursToExpiry < 24) {
                        return this._replaceArguments(this.contents[
                                type], productCaption, 'in ' +
                            hoursToExpiry + ' hours');
                    } else if (daysToExpiry < 30) {
                        return this._replaceArguments(this.contents[
                                type], productCaption, 'in ' +
                            daysToExpiry + ' days');
                    } else {
                        return this._replaceArguments(this.contents[
                                type], productCaption, 'on ' +
                            expiryDateISOFormat);
                    }

                } else {
                    return this._replaceArguments(this.contents[
                        type], productCaption);
                }
            },

            _replaceArguments: function(string) {
                var newString = string;
                for (var i = 1; i < arguments.length; i++) {
                    newString = newString.replace('{' + (i - 1) +
                        '}', arguments[i]);
                }

                return newString;
            },

            _padDate: function(date) {
                if (date.toString().length === 1) {
                    return '0' + date;
                } else {
                    return date;
                }
            }

        });
    </script>
</dom-module>
